"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.prv2bigint = prv2bigint;
exports.prv2pub = prv2pub;
exports.signWithHasher = signWithHasher;
exports.verifyWithHasher = verifyWithHasher;
exports.packSignature = packSignature;
exports.unpackSignature = unpackSignature;
exports.pruneBuffer = pruneBuffer;

var _blakeHash = _interopRequireDefault(require("blake-hash"));

var _ffjs = require("./ffjs");

var _circomlib = require("circomlib");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function pruneBuffer(_buff) {
  var buff = Buffer.from(_buff);
  buff[0] = buff[0] & 0xf8;
  buff[31] = buff[31] & 0x7f;
  buff[31] = buff[31] | 0x40;
  return buff;
}

function prv2bigint(prv) {
  var sBuff = pruneBuffer((0, _blakeHash["default"])("blake512").update(prv).digest().slice(0, 32));

  var s = _ffjs.ffutils.leBuff2int(sBuff);

  return _ffjs.Scalar.shr(s, 3);
}

function prv2pub(prv) {
  var A = _circomlib.babyJub.mulPointEscalar(_circomlib.babyJub.Base8, prv2bigint(prv));

  return A;
}

function signWithHasher(prv, msg, hasher) {
  var h1 = (0, _blakeHash["default"])("blake512").update(prv).digest();
  var sBuff = pruneBuffer(h1.slice(0, 32));

  var s = _ffjs.ffutils.leBuff2int(sBuff);

  var A = _circomlib.babyJub.mulPointEscalar(_circomlib.babyJub.Base8, _ffjs.Scalar.shr(s, 3));

  var msgBuff = _ffjs.ffutils.leInt2Buff(msg, 32);

  var rBuff = (0, _blakeHash["default"])("blake512").update(Buffer.concat([h1.slice(32, 64), msgBuff])).digest();

  var r = _ffjs.ffutils.leBuff2int(rBuff);

  var Fr = new _ffjs.F1Field(_circomlib.babyJub.subOrder);
  r = Fr.e(r);

  var R8 = _circomlib.babyJub.mulPointEscalar(_circomlib.babyJub.Base8, r);

  var hm = hasher([R8[0], R8[1], A[0], A[1], msg]);
  var S = Fr.add(r, Fr.mul(hm, s));
  return {
    R8: R8,
    S: S
  };
}

function verifyWithHasher(msg, sig, A, hasher) {
  // Check parameters
  if (_typeof(sig) != "object") return false;
  if (!Array.isArray(sig.R8)) return false;
  if (sig.R8.length != 2) return false;
  if (!_circomlib.babyJub.inCurve(sig.R8)) return false;
  if (!Array.isArray(A)) return false;
  if (A.length != 2) return false;
  if (!_circomlib.babyJub.inCurve(A)) return false;
  if (sig.S >= _circomlib.babyJub.subOrder) return false;
  var hm = hasher([sig.R8[0], sig.R8[1], A[0], A[1], msg]);

  var Pleft = _circomlib.babyJub.mulPointEscalar(_circomlib.babyJub.Base8, sig.S);

  var Pright = _circomlib.babyJub.mulPointEscalar(A, _ffjs.Scalar.mul(hm, 8));

  Pright = _circomlib.babyJub.addPoint(sig.R8, Pright);
  if (!_circomlib.babyJub.F.eq(Pleft[0], Pright[0])) return false;
  if (!_circomlib.babyJub.F.eq(Pleft[1], Pright[1])) return false;
  return true;
}

function packSignature(sig) {
  var R8p = _circomlib.babyJub.packPoint(sig.R8);

  var Sp = _ffjs.ffutils.leInt2Buff(sig.S, 32);

  return Buffer.concat([R8p, Sp]);
}

function unpackSignature(sigBuff) {
  return {
    R8: _circomlib.babyJub.unpackPoint(sigBuff.slice(0, 32)),
    S: _ffjs.ffutils.leBuff2int(sigBuff.slice(32, 64))
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9lZGRzYS50cyJdLCJuYW1lcyI6WyJwcnVuZUJ1ZmZlciIsIl9idWZmIiwiYnVmZiIsIkJ1ZmZlciIsImZyb20iLCJwcnYyYmlnaW50IiwicHJ2Iiwic0J1ZmYiLCJ1cGRhdGUiLCJkaWdlc3QiLCJzbGljZSIsInMiLCJmZnV0aWxzIiwibGVCdWZmMmludCIsIlNjYWxhciIsInNociIsInBydjJwdWIiLCJBIiwiYmFieUp1YiIsIm11bFBvaW50RXNjYWxhciIsIkJhc2U4Iiwic2lnbldpdGhIYXNoZXIiLCJtc2ciLCJoYXNoZXIiLCJoMSIsIm1zZ0J1ZmYiLCJsZUludDJCdWZmIiwickJ1ZmYiLCJjb25jYXQiLCJyIiwiRnIiLCJGMUZpZWxkIiwic3ViT3JkZXIiLCJlIiwiUjgiLCJobSIsIlMiLCJhZGQiLCJtdWwiLCJ2ZXJpZnlXaXRoSGFzaGVyIiwic2lnIiwiQXJyYXkiLCJpc0FycmF5IiwibGVuZ3RoIiwiaW5DdXJ2ZSIsIlBsZWZ0IiwiUHJpZ2h0IiwiYWRkUG9pbnQiLCJGIiwiZXEiLCJwYWNrU2lnbmF0dXJlIiwiUjhwIiwicGFja1BvaW50IiwiU3AiLCJ1bnBhY2tTaWduYXR1cmUiLCJzaWdCdWZmIiwidW5wYWNrUG9pbnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7Ozs7O0FBRUEsU0FBU0EsV0FBVCxDQUFxQkMsS0FBckIsRUFBNEI7QUFDMUIsTUFBTUMsSUFBSSxHQUFHQyxNQUFNLENBQUNDLElBQVAsQ0FBWUgsS0FBWixDQUFiO0FBQ0FDLEVBQUFBLElBQUksQ0FBQyxDQUFELENBQUosR0FBVUEsSUFBSSxDQUFDLENBQUQsQ0FBSixHQUFVLElBQXBCO0FBQ0FBLEVBQUFBLElBQUksQ0FBQyxFQUFELENBQUosR0FBV0EsSUFBSSxDQUFDLEVBQUQsQ0FBSixHQUFXLElBQXRCO0FBQ0FBLEVBQUFBLElBQUksQ0FBQyxFQUFELENBQUosR0FBV0EsSUFBSSxDQUFDLEVBQUQsQ0FBSixHQUFXLElB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LENBQVQ7QUFFQSxNQUFJLENBQUM1QixtQkFBUThCLENBQVIsQ0FBVUMsRUFBVixDQUFhSixLQUFLLENBQUMsQ0FBRCxDQUFsQixFQUF1QkMsTUFBTSxDQUFDLENBQUQsQ0FBN0IsQ0FBTCxFQUF3QyxPQUFPLEtBQVA7QUFDeEMsTUFBSSxDQUFDNUIsbUJBQVE4QixDQUFSLENBQVVDLEVBQVYsQ0FBYUosS0FBSyxDQUFDLENBQUQsQ0FBbEIsRUFBdUJDLE1BQU0sQ0FBQyxDQUFELENBQTdCLENBQUwsRUFBd0MsT0FBTyxLQUFQO0FBQ3hDLFNBQU8sSUFBUDtBQUNEOztBQUVELFNBQVNJLGFBQVQsQ0FBdUJWLEdBQXZCLEVBQTRCO0FBQzFCLE1BQU1XLEdBQUcsR0FBR2pDLG1CQUFRa0MsU0FBUixDQUFrQlosR0FBRyxDQUFDTixFQUF0QixDQUFaOztBQUNBLE1BQU1tQixFQUFFLEdBQUd6QyxjQUFRYyxVQUFSLENBQW1CYyxHQUFHLENBQUNKLENBQXZCLEVBQTBCLEVBQTFCLENBQVg7O0FBQ0EsU0FBT2pDLE1BQU0sQ0FBQ3lCLE1BQVAsQ0FBYyxDQUFDdUIsR0FBRCxFQUFNRSxFQUFOLENBQWQsQ0FBUDtBQUNEOztBQUVELFNBQVNDLGVBQVQsQ0FBeUJDLE9BQXpCLEVBQWtDO0FBQ2hDLFNBQU87QUFDTHJCLElBQUFBLEVBQUUsRUFBRWhCLG1CQUFRc0MsV0FBUixDQUFvQkQsT0FBTyxDQUFDN0MsS0FBUixDQUFjLENBQWQsRUFBaUIsRUFBakIsQ0FBcEIsQ0FEQztBQUVMMEIsSUFBQUEsQ0FBQyxFQUFFeEIsY0FBUUMsVUFBUixDQUFtQjBDLE9BQU8sQ0FBQzdDLEtBQVIsQ0FBYyxFQUFkLEVBQWtCLEVBQWxCLENBQW5CO0FBRkUsR0FBUDtBQUlEIiwic291cmNlc0NvbnRlbnQiOlsiLyogbW9kaWZpZWQgZnJvbSBjaXJjb21saWIvc3JjL2VkZHNhLmpzICovXG5cbmltcG9ydCBjcmVhdGVCbGFrZUhhc2ggZnJvbSBcImJsYWtlLWhhc2hcIjtcbmltcG9ydCB7IFNjYWxhciwgRjFGaWVsZCwgZmZ1dGlscyB9IGZyb20gXCIuL2ZmanNcIjtcbmltcG9ydCB7IGJhYnlKdWIsIHBvc2VpZG9uIH0gZnJvbSBcImNpcmNvbWxpYlwiO1xuXG5mdW5jdGlvbiBwcnVuZUJ1ZmZlcihfYnVmZikge1xuICBjb25zdCBidWZmID0gQnVmZmVyLmZyb20oX2J1ZmYpO1xuICBidWZmWzBdID0gYnVmZlswXSAmIDB4Zjg7XG4gIGJ1ZmZbMzFdID0gYnVmZlszMV0gJiAweDdmO1xuICBidWZmWzMxXSA9IGJ1ZmZbMzFdIHwgMHg0MDtcbiAgcmV0dXJuIGJ1ZmY7XG59XG5cbmZ1bmN0aW9uIHBydjJiaWdpbnQocHJ2KSB7XG4gIGNvbnN0IHNCdWZmID0gcHJ1bmVCdWZmZXIoXG4gICAgY3JlYXRlQmxha2VIYXNoKFwiYmxha2U1MTJcIikudXBkYXRlKHBydikuZGlnZXN0KCkuc2xpY2UoMCwgMzIpXG4gICk7XG4gIGxldCBzID0gZmZ1dGlscy5sZUJ1ZmYyaW50KHNCdWZmKTtcbiAgcmV0dXJuIFNjYWxhci5zaHIocywgMyk7XG59XG5cbmZ1bmN0aW9uIHBydjJwdWIocHJ2KSB7XG4gIGNvbnN0IEEgPSBiYWJ5SnViLm11bFBvaW50RXNjYWxhcihiYWJ5SnViLkJhc2U4LCBwcnYyYmlnaW50KHBydikpO1xuICByZXR1cm4gQTtcbn1cblxuZnVuY3Rpb24gc2lnbldpdGhIYXNoZXIocHJ2LCBtc2csIGhhc2hlcikge1xuICBjb25zdCBoMSA9IGNyZWF0ZUJsYWtlSGFzaChcImJsYWtlNTEyXCIpLnVwZGF0ZShwcnYpLmRpZ2VzdCgpO1xuICBjb25zdCBzQnVmZiA9IHBydW5lQnVmZmVyKGgxLnNsaWNlKDAsIDMyKSk7XG4gIGNvbnN0IHMgPSBmZnV0aWxzLmxlQnVmZjJpbnQoc0J1ZmYpO1xuICBjb25zdCBBID0gYmFieUp1Yi5tdWxQb2ludEVzY2FsYXIoYmFieUp1Yi5CYXNlOCwgU2NhbGFyLnNocihzLCAzKSk7XG5cbiAgY29uc3QgbXNnQnVmZiA9IGZmdXRpbHMubGVJbnQyQnVmZihtc2csIDMyKTtcbiAgY29uc3QgckJ1ZmYgPSBjcmVhdGVCbGFrZUhhc2goXCJibGFrZTUxMlwiKVxuICAgIC51cGRhdGUoQnVmZmVyLmNvbmNhdChbaDEuc2xpY2UoMzIsIDY0KSwgbXNnQnVmZl0pKVxuICAgIC5kaWdlc3QoKTtcbiAgbGV0IHIgPSBmZnV0aWxzLmxlQnVmZjJpbnQockJ1ZmYpO1xuICBjb25zdCBGciA9IG5ldyBGMUZpZWxkKGJhYnlKdWIuc3ViT3JkZXIpO1xuICByID0gRnIuZShyKTtcbiAgY29uc3QgUjggPSBiYWJ5SnViLm11bFBvaW50RXNjYWxhcihiYWJ5SnViLkJhc2U4LCByKTtcbiAgY29uc3QgaG0gPSBoYXNoZXIoW1I4WzBdLCBSOFsxXSwgQVswXSwgQVsxXSwgbXNnXSk7XG4gIGNvbnN0IFMgPSBGci5hZGQociwgRnIubXVsKGhtLCBzKSk7XG4gIHJldHVybiB7XG4gICAgUjg6IFI4LFxuICAgIFM6IFMsXG4gIH07XG59XG5cbmZ1bmN0aW9uIHZlcmlmeVdpdGhIYXNoZXIobXNnLCBzaWcsIEEsIGhhc2hlcikge1xuICAvLyBDaGVjayBwYXJhbWV0ZXJzXG4gIGlmICh0eXBlb2Ygc2lnICE9IFwib2JqZWN0XCIpIHJldHVybiBmYWxzZTtcbiAgaWYgKCFBcnJheS5pc0FycmF5KHNpZy5SOCkpIHJldHVybiBmYWxzZTtcbiAgaWYgKHNpZy5SOC5sZW5ndGggIT0gMikgcmV0dXJuIGZhbHNlO1xuICBpZiAoIWJhYnlKdWIuaW5DdXJ2ZShzaWcuUjgpKSByZXR1cm4gZmFsc2U7XG4gIGlmICghQXJyYXkuaXNBcnJheShBKSkgcmV0dXJuIGZhbHNlO1xuICBpZiAoQS5sZW5ndGggIT0gMikgcmV0dXJuIGZhbHNlO1xuICBpZiAoIWJhYnlKdWIuaW5DdXJ2ZShBKSkgcmV0dXJuIGZhbHNlO1xuICBpZiAoc2lnLlMgPj0gYmFieUp1Yi5zdWJPcmRlcikgcmV0dXJuIGZhbHNlO1xuXG4gIGNvbnN0IGhtID0gaGFzaGVyKFtzaWcuUjhbMF0sIHNpZy5SOFsxXSwgQVswXSwgQVsxXSwgbXNnXSk7XG5cbiAgY29uc3QgUGxlZnQgPSBiYWJ5SnViLm11bFBvaW50RXNjYWxhcihiYWJ5SnViLkJhc2U4LCBzaWcuUyk7XG4gIGxldCBQcmlnaHQgPSBiYWJ5SnViLm11bFBvaW50RXNjYWxhcihBLCBTY2FsYXIubXVsKGhtLCA4KSk7XG4gIFByaWdodCA9IGJhYnlKdWIuYWRkUG9pbnQoc2lnLlI4LCBQcmlnaHQpO1xuXG4gIGlmICghYmFieUp1Yi5GLmVxKFBsZWZ0WzBdLCBQcmlnaHRbMF0pKSByZXR1cm4gZmFsc2U7XG4gIGlmICghYmFieUp1Yi5GLmVxKFBsZWZ0WzFdLCBQcmlnaHRbMV0pKSByZXR1cm4gZmFsc2U7XG4gIHJldHVybiB0cnVlO1xufVxuXG5mdW5jdGlvbiBwYWNrU2lnbmF0dXJlKHNpZykge1xuICBjb25zdCBSOHAgPSBiYWJ5SnViLnBhY2tQb2ludChzaWcuUjgpO1xuICBjb25zdCBTcCA9IGZmdXRpbHMubGVJbnQyQnVmZihzaWcuUywgMzIpO1xuICByZXR1cm4gQnVmZmVyLmNvbmNhdChbUjhwLCBTcF0pO1xufVxuXG5mdW5jdGlvbiB1bnBhY2tTaWduYXR1cmUoc2lnQnVmZikge1xuICByZXR1cm4ge1xuICAgIFI4OiBiYWJ5SnViLnVucGFja1BvaW50KHNpZ0J1ZmYuc2xpY2UoMCwgMzIpKSxcbiAgICBTOiBmZnV0aWxzLmxlQnVmZjJpbnQoc2lnQnVmZi5zbGljZSgzMiwgNjQpKSxcbiAgfTtcbn1cblxuZXhwb3J0IHtcbiAgcHJ2MmJpZ2ludCxcbiAgcHJ2MnB1YixcbiAgc2lnbldpdGhIYXNoZXIsXG4gIHZlcmlmeVdpdGhIYXNoZXIsXG4gIHBhY2tTaWduYXR1cmUsXG4gIHVucGFja1NpZ25hdHVyZSxcbiAgcHJ1bmVCdWZmZXIsXG59O1xuIl19